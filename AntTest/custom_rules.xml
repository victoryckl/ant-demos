<?xml version="1.0" encoding="UTF-8"?>
<project name="custom_rules">
    <property name="project.dir" value="${basedir}" />
    <echo message="project.dir:${project.dir}" />
    
    <property name="auto.version.is.time" value="true" />
    
    <taskdef resource="net/sf/antcontrib/antcontrib.properties">
		<classpath>
			<pathelement location="${project.dir}/../ant-tools/ant-contrib-1.0b3.jar" />  
		</classpath>
    </taskdef>
    
    <target name="property-config">
        <xmlproperty file="AndroidManifest.xml" collapseAttributes="true" />
        <echo message="package: ${manifest.package}" />
        <echo message="versionName: ${manifest.android:versionName}" />
        
<!--         <propertyregex property="ver.name" 
			input="${manifest.android:versionName}" regexp="(.*)\." select="\1"/> -->
        <propertyregex property="ver.ver" 
            input="${manifest.android:versionName}" regexp="(\d\.\d\.\d\.\d\d\d\d\d\d_[A-Za-z]+$)" select="\1"/>
        <echo message="ver.ver: ${ver.ver}" />
        
        <condition property="scondition">
            <!--如果属性name不存在则返回false-->
            <isset property="ver.ver"/>
        </condition>  
        <antcall target="isTrue"></antcall>
        <antcall target="isFalse"></antcall>
        
        <propertyregex property="ver.name" 
            input="${manifest.android:versionName}" regexp="^(\d\.\d\.\d)\." select="\1"/>
        <propertyregex property="ver.date" 
            input="${manifest.android:versionName}" regexp="\.(\d\d\d\d\d\d)\_" select="\1"/>
        <propertyregex property="ver.flag" 
            input="${manifest.android:versionName}" regexp="(_[A-Za-z]+$)" select="\1"/>
        <echo message="ver.name: ${ver.name}" />
        <echo message="ver.date: ${ver.date}" />
        <echo message="ver.flag: ${ver.flag}" />
        
        <script language="javascript">
            <![CDATA[
                property = project.setProperty("time.now", Math.floor((new Date()).getTime()/1000));
            ]]>
        </script>
        <tstamp>
            <format property="auto.versionCode"
                  pattern="${time.now}" locale="cn"/>
            <format property="auto.versionName"
                  pattern="yyMMdd" locale="cn"/>
        </tstamp>
        
        <property name="auto.final.versionCode" value="${auto.versionCode}" />
        <property name="auto.final.versionName" value="0.2.8.${auto.versionName}_beta" />
        
        <echo message="auto.version.is.time: ${auto.version.is.time}" />
        <echo message="versionCode: ${auto.final.versionCode}" />
        <echo message="versionName: ${auto.final.versionName}" />
        
    </target>

    <target name="isTrue" if="scondition">
        <echo>is ture</echo>
	</target>
	<target name="isFalse" unless="scondition">
	    <echo>is false</echo>
	</target>
	
    <target name="change-version" if="auto.version.is.time" depends="property-config">
<!--         <replaceregexp file="${auto.project.tmp.dir}/AndroidManifest.xml"
           match="android:versionCode=&quot;(\d+)&quot;"
           replace="android:versionCode=&quot;${auto.final.versionCode}&quot;"
        />
        <replaceregexp file="${auto.project.tmp.dir}/AndroidManifest.xml"
           match="android:versionName=&quot;([a-zA-Z0-9\.]+)&quot;"
           replace="android:versionName=&quot;${auto.final.versionName}&quot;"
        /> -->
    </target>

</project>
